<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量上传眼底图像 - 诊断系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <style>
        /* 绿色主题 */
       .btn-primary {
            background-color: #047857;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

       .btn-primary:hover {
            background-color: #065f46;
        }

        /* 上传区域（固定大小） */
       .upload-box {
            /* border: 2px dashed #047857; */
            background-color: #ffffff;
            padding: 40px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 8px 32px 0 rgba(124, 125, 141, 0.501);
        }

       .upload-box:hover {
            background-color: #f0fdfa;
        }

        /* 系统功能介绍区 */
       .service-box {
            /* border: 2px dashed #047857; */
            background-color: #ffffff;
            padding: 40px;
            text-align: left;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            box-shadow: 0 8px 32px 0 rgba(124, 125, 141, 0.501);
        }

        /* 预览区 */
       .preview-group {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 8px 32px 0 rgba(124, 125, 141, 0.501);
            text-align: center;
            width: 100%;
        }

        /* 图片横向排列 */
       .image-pair {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

       .image-pair img {
            width: 45%;
            height: auto;
            border-radius: 8px;
        }

        /* 输入表样式 */
       .input-table {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

       .input-table input,.input-table select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* 全局样式，设置过渡效果和字体 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            transition: all 0.3s ease;
        }

        /* 玻璃拟态效果 */
       .glassmorphism {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            box-shadow: 0 8px 32px 0 rgba(124, 125, 141, 0.501);
        }

        /* 按钮悬停缩放效果 */
       .hover-scale {
            transition: transform 0.3s ease;
        }

       .hover-scale:hover {
            transform: scale(1.05);
        }

        /* 输入框和选择框样式 */
        input[type="text"],
        input[type="number"],
        select {
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #22c55e;
            outline: none;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.25);
        }

        /* 输入框和选择框鼠标悬停效果 */
        input[type="text"]:hover,
        input[type="number"]:hover,
        select:hover {
            border-color: #22c55e;
        }

        /* 动画效果，淡入 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

       .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        /* 模态框样式 */
       .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        /* 在 modal-content 上也加 glassmorphism */
       .modal-content {
            margin: 5% auto;
            padding: 60px;
            width: 80%;
            height: 80%;
            position: relative;
            border-radius: 8px;
            display: flex;
            flex-direction: column;

            /* 玻璃拟态 */
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(124, 125, 141, 0.501);
        }

        /* 模态框内图片样式 */
       .modal-content img {
            object-fit: contain;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            transform-origin: top left;
        }

        /* 关闭按钮，右上角 */
       .close {
            position: absolute;
            top: 8px;
            right: 12px;
            color: #ffffff;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

       .close:hover,.close:focus {
            color: black;
            text-decoration: none;
        }

        /* 避免系统功能部分与上面重叠 */
        #services {
            margin-top: 30px;
        }

        /* 缩放按钮样式，移动到左上角 */
       .zoom-btn-container {
            position: absolute;
            top: 8px;
            left: 8px;
            display: flex;
            gap: 0.5rem;
        }

       .zoom-btn {
            background-color: #f3f4f6;
            color: #374151;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            margin: 0.25rem 0;
            transition: background-color 0.3s ease;
        }

       .zoom-btn:hover {
            background-color: #e5e7eb;
        }

        /* 诊断结果报告盒子 */
       .diagnosis-report {
            background-color: #e5e7eb;
            padding: 15px;
            border-radius: 10px;
            /* box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); */
            text-align: center;
            width: 100%;
            margin-top: 10px;
            display: none;
        }

        #services {
            margin-top: 30px;
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- 头部 -->
    <header class="bg-green-900 text-white p-4 flex justify-between items-center rounded-lg shadow-md fade-in">
        <h1 class="text-2xl font-bold">OphthaAI眼科疾病智能诊断系统</h1>
        <nav>
            <ul class="flex space-x-4">
                <li><a href="/" class="hover:underline">返回首页</a></li>
                <li><a href="#diagnosis" class="hover:underline">智能诊断结果</a></li>
                <!-- <li><a href="#services" class="hover:underline">服务介绍</a></li> -->
                <!-- <li><a href="#contact" class="hover:underline">我们</a></li> -->
            </ul>
        </nav>
    </header>
    <section class="container mx-auto mt-8 text-center">
        <h2 class="text-3xl font-semibold text-gray-900" style="font-size: 2.8rem;">上传批量影像进行智能诊断</h2>
    </section>
    <!-- 上传区域（最上方） -->
    <section class="container mx-auto mt-8 p-6">
        <div class="upload-box w-full" id="upload-box">
            <p class="text-lg text-gray-700">点击上传批量影像</p>
            <input type="file" id="file-input" multiple class="hidden">
            <button class="btn-primary mt-4" onclick="document.getElementById('file-input').click();">选择文件</button>
        </div>
    </section>

    <!-- 预览区（中间） -->
    <section class="container mx-auto mt-8 p-6" id="diagnosis">
        <!-- <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">预览区</h2> -->
        <div class="space-y-6" id="preview-grid">
            <!-- 这里动态生成图片和输入表 -->
        </div>
        <br>
        <br>
        <!-- 提交分析按钮 -->
        <button class="bg-green-600 text-white py-3 w-full rounded-lg shadow-md text-lg font-semibold text-center hover:bg-green-700 transition duration-300 hover-scale" id="submit-btn">提交分析</button>
        <div id="report-grid" style="display: none;">
            <!-- 这里动态生成诊断结果报告 -->
        </div>
    </section>
    <!-- 功能介绍区域 -->
    <section class="container mx-auto mt-8 p-6">
        <div class="service-box w-full" id="service">
            <h2 class="text-xl font-semibold mb-4">系统功能</h2>
            <ul class="list-disc pl-6">
                <li>眼底影像自动分析</li>
                <li>白内障、青光眼等疾病检测</li>
                <li>详细诊断报告生成</li>
                <li>眼底热力图生成</li>
            </ul>
        </div>
    </section>

    <!-- 底部 -->
    <footer class="bg-green-900 text-white text-center p-4 mt-12">
        <p>© 2025 OphthaAI眼科疾病智能诊断系统 | 版权所有</p>
    </footer>

    <script>
      document.getElementById('file-input').addEventListener('change', function (event) {
    const files = event.target.files;
    const previewGrid = document.getElementById('preview-grid');
    // 检查上传的图像数量是否为偶数
    if (files.length % 2!== 0) {
        alert('上传的图像必须是偶数张，请重新选择！');
        this.value = ''; // 清空已选文件
        return;
    }
    previewGrid.innerHTML = ''; // 清空之前的内容
    document.getElementById('report-grid').style.display = 'none';

    for (let i = 0; i < files.length; i += 2) {
        const group = document.createElement('div');
        group.className = 'preview-group p-4';

        const imageWrapper = document.createElement('div');
        imageWrapper.className = 'image-pair'; // 横向排列

        for (let j = 0; j < 2 && (i + j) < files.length; j++) {
            const file = files[i + j];
            const reader = new FileReader();
            const imgElement = document.createElement('img');

            reader.onload = function (e) {
                imgElement.src = e.target.result;
            };
            reader.readAsDataURL(file);
            imageWrapper.appendChild(imgElement);
        }

        const inputTable = document.createElement('div');
        inputTable.className = 'input-table';

        const ageInput = document.createElement('input');
        ageInput.type = 'number';
        ageInput.placeholder = '年龄';
        ageInput.required = true;
        ageInput.min = 0;
        ageInput.name = 'age';

        const genderSelect = document.createElement('select');
        const maleOption = document.createElement('option');
        maleOption.value = '男';
        maleOption.textContent = '男';
        const femaleOption = document.createElement('option');
        femaleOption.value = '女';
        femaleOption.textContent = '女';
        genderSelect.appendChild(maleOption);
        genderSelect.appendChild(femaleOption);
        genderSelect.required = true;
        genderSelect.name = 'gender';

        inputTable.appendChild(ageInput);
        inputTable.appendChild(genderSelect);

        // 添加用于显示诊断结果的元素
        const reportBox = document.createElement('div');
        reportBox.className = 'diagnosis-report';
        const reportText = document.createElement('p');
        reportBox.appendChild(reportText);

        // 添加用于显示热力图的元素
        const heatmapSection = document.createElement('div');
        heatmapSection.id = 'heatmap-section';
        heatmapSection.className = 'hidden';
        reportBox.appendChild(heatmapSection);

        group.appendChild(imageWrapper);
        group.appendChild(inputTable);
        group.appendChild(reportBox);
        previewGrid.appendChild(group);
    }
});

document.getElementById('submit-btn').addEventListener('click', async function () {
    const previewGroups = document.querySelectorAll('.preview-group');
    const formData = new FormData();
    const files = document.getElementById('file-input').files;

    for (let i = 0; i < previewGroups.length; i++) {
        const ageInput = previewGroups[i].querySelector('input[type="number"]');
        const genderSelect = previewGroups[i].querySelector('select');

        if (!ageInput.value ||!genderSelect.value) {
            alert('请确保所有年龄和性别输入表都已填写！');
            return;
        }

        if (parseInt(ageInput.value) < 0) {
            alert('年龄不能为负数，请重新输入！');
            ageInput.focus();
            return;
        }

        // 正确添加年龄和性别数据
        formData.append('age', ageInput.value);
        formData.append('gender', genderSelect.value);
    }

    for (let i = 0; i < files.length; i++) {
        formData.append('images', files[i]);
    }

    // 显示诊断结果框并设置提示信息
    previewGroups.forEach((group) => {
        const reportBox = group.querySelector('.diagnosis-report');
        const reportText = reportBox.querySelector('p');
        reportBox.style.display = 'block';
        reportText.textContent = '正在生成智能诊断结果...';
    });

    try {
        const response = await fetch('/batch_upload', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.status ==='success') {
            // 处理成功响应，在对应图片组下方显示诊断结果
            const results = result.results;
            previewGroups.forEach((group, index) => {
                const reportBox = group.querySelector('.diagnosis-report');
                const reportText = reportBox.querySelector('p');
                const heatmapSection = reportBox.querySelector('#heatmap-section');

                let diagnosisText = "<strong style='font-size: x-large;'>智能诊断结果</strong><br>"; // 增大诊断结果标题字体大小
                let diseases = [];
                if (results[index] && Array.isArray(results[index].predictions) && results[index].diseases) {
                    results[index].predictions.forEach((pred, predIndex) => {
                        if (pred === 1) {
                            const diseaseCode = results[index].diseases[predIndex];
                            let diseaseName = "未知疾病";
                            switch (diseaseCode) {
                                case 'N':
                                    diseaseName = "正常";
                                    break;
                                case 'D':
                                    diseaseName = "糖尿病";
                                    break;
                                case 'G':
                                    diseaseName = "青光眼";
                                    break;
                                case 'C':
                                    diseaseName = "白内障";
                                    break;
                                case 'A':
                                    diseaseName = "AMD";
                                    break;
                                case 'H':
                                    diseaseName = "高血压";
                                    break;
                                case 'M':
                                    diseaseName = "近视";
                                    break;
                                case 'O':
                                    diseaseName = "其他疾病/异常";
                                    break;
                            }
                            diseases.push(diseaseName);
                        }
                    });
                }
                if (diseases.length === 0) {
                    diagnosisText += "<span style='font-size: larger;'>未检测到疾病</span>";
                } else {
                    diagnosisText += "<span style='font-size: larger;'>诊断结果：</span>";
                    diseases.forEach((disease, diseaseIndex) => {
                        diagnosisText += `<span style='font-size: larger;'>${disease}</span>`;
                        if (diseaseIndex!== diseases.length - 1) {
                            diagnosisText += '，';
                        }
                    });
                    diagnosisText += "<br><br><strong style='font-size: x-large;'>治疗建议：</strong><br>";
                    diseases.forEach((disease) => {
                        diagnosisText += generateTreatmentAdvice(disease);
                    });
                }
                diagnosisText += "<br><br><strong style='font-size: x-large;'>热力图</strong><br>";

                reportText.innerHTML = diagnosisText;
                reportBox.style.textAlign = 'left';
                reportBox.style.display = 'block';

                if (results[index] && results[index].heatmaps) {
                    heatmapSection.classList.remove('hidden');
                    const heatmapObjs = results[index].heatmaps;
                    if (Array.isArray(heatmapObjs)) {
                        heatmapObjs.forEach((heatmapObj) => {
                            const img = document.createElement('img');
                            img.src = heatmapObj.heatmap;
                            img.alt = `Disease: ${heatmapObj.disease}`;
                            img.className = 'rounded shadow-md max-w-full h-auto my-2';
                            heatmapSection.appendChild(img);
                        });
                    } else {
                        const img = document.createElement('img');
                        img.src = heatmapObjs.heatmap;
                        img.alt = `Disease: ${heatmapObjs.disease}`;
                        img.className = 'rounded shadow-md max-w-full h-auto my-2';
                        heatmapSection.appendChild(img);
                    }
                }
            });
        } else {
            console.error('批量上传失败:', result.message);
            // 请求失败时更新诊断结果文本
            previewGroups.forEach((group) => {
                const reportBox = group.querySelector('.diagnosis-report');
                const reportText = reportBox.querySelector('p');
                reportText.textContent = '加载失败，请检查网络或重试。';
                const heatmapSection = reportBox.querySelector('#heatmap-section');
                heatmapSection.style.display = 'none';
            });
        }
    } catch (error) {
        console.error('网络错误:', error);
        // 网络错误时更新诊断结果文本
        previewGroups.forEach((group) => {
            const reportBox = group.querySelector('.diagnosis-report');
            const reportText = reportBox.querySelector('p');
            reportText.textContent = '加载失败，请检查网络或重试。';
            const heatmapSection = reportBox.querySelector('#heatmap-section');
            heatmapSection.style.display = 'none';
        });
    }
});

function generateTreatmentAdvice(disease) {
    let advice = `<span style='font-size: larger;'><strong>${disease}：</strong><br>`;
    switch (disease) {
        case '高血压':
            advice += `有效控制高血压，使病变吸收消退<br>`;
            break;
        case '近视':
            advice += `1. 矫正镜片：<br>`;
            advice += `    (1) 框架眼镜，简单安全，可矫正多种屈光不正。<br>`;
            advice += `    (2) 隐形眼镜，直接戴在角膜上，材料和护理有差异<br>`;
            advice += `2. 屈光手术：<br>`;
            advice += `    (1) LASIK，做角膜瓣后用激光使角膜变平，恢复快、不适感少<br>`;
            advice += `    (2) LASEK，做超薄角膜瓣，激光重塑角膜后放回上皮<br>`;
            advice += `    (3) PRK，去除上皮后激光重塑角膜，靠上皮自然再生<br>`;
            advice += `    (4) SMILE，不做角膜瓣和去除上皮，取出角膜基质透镜<br>`;
            advice += `3. 减缓近视度数加深疗法：<br>`;
            advice += `    (1) 低剂量阿托品滴眼液，可减缓近视进展<br>`;
            advice += `    (2) 延长户外时间，降低近视风险<br>`;
            advice += `    (3) 双焦点隐形眼镜，对减缓近视有一定效果<br>`;
            advice += `    (4) 矫正角膜术，夜间佩戴硬性隐形眼镜重塑角膜<br></span>`;
            break;
        case 'AMD':
            advice += `1. 湿性：<br>`;
            advice += `    (1) 眼内注射抗VEGF药物抑制新生血管，如雷珠单抗、阿柏西普<br>`;
            advice += `    (2) 光动力疗法用激光激活药物封闭异常血管<br>`;
            advice += `    (3) 激光光凝术直接破坏异常血管<br>`;
            advice += `    (4) 手术治疗如黄斑转位术、视网膜下新生血管膜切除术<br>`;
            advice += `2. 干性：<br>`;
            advice += `    (1) 中晚期服特定维生素矿物质制剂<br>`;
            advice += `    (2) 低视力康复专家协助适应视力变化<br>`;
            advice += `    (3) 部分晚期患者可植入可伸缩式人工晶体<br></span>`;
            break;
        case '白内障':
            advice += `手术是有效治疗手段，晶状体乳化法是常见手术方式<br></span>`;
            break;
        case '糖尿病':
            advice += `1. 早期病变：<br>轻度或中度NPDR可能无需立即治疗，密切监测<br>`;
            advice += `2. 晚期病变：<br>`;
            advice += `    (1) 眼内注药抑制新血管生长和体液积聚<br>`;
            advice += `    (2) 光凝阻止或减缓血液和液体渗漏<br>`;
            advice += `    (3) 全视网膜光凝使异常血管萎缩<br>`;
            advice += `    (4) 玻璃体切除术清除血液和瘢痕组织<br></span>`;
            break;
        case '青光眼':
            advice += `1. 处方滴眼液，如前列腺素类等多种药物<br>`;
            advice += `2. 口服药物，通常为碳酸酐酶抑制剂<br>`;
            advice += `3. 激光疗法，如激光小梁成形术<br>`;
            advice += `4. 手术，如小梁切除术等<br></span>`;
            break;
        case '正常':
            advice += `无<br></span>`;
            break;
        default:
            advice += `无特定治疗建议，请咨询医生<br></span>`;
    }
    return advice;
}
        </script>
</body>
</html>